let SuspiciousSignins = SigninLogs
| where isnotempty(UserAgent)
| where UserAgent has_any ("axios", "curl", "python-requests", "httpclient", "Go-http-client")
| where RiskState == "atRisk" or RiskLevelDuringSignIn == "high"
| project SigninTime = TimeGenerated, UserPrincipalName, IPAddress, UserAgent, RiskState, RiskLevelDuringSignIn, AppDisplayName;
let SuspiciousClicks = UrlClickEvents
| where isnotempty(Url)
| where Url has_any ("login.microsoftonline.com", "graph.microsoft.com", "outlook.office365.com")
| where IsClickedThrough == true
| project ClickTime = TimeGenerated, AccountUpn, Url, IPAddress;
SuspiciousClicks
| join kind=inner SuspiciousSignins on $left.AccountUpn == $right.UserPrincipalName and $left.IPAddress == $right.IPAddress
| where SigninTime between (ClickTime .. ClickTime + 30m)
| project User = AccountUpn, IPAddress, Url, ClickTime, SigninTime, UserAgent, RiskState, RiskLevelDuringSignIn, AppDisplayName
| order by SigninTime desc