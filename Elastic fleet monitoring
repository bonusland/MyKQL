// 1. Source both the Entra Device Inventory and Fleet Agent Heartbeats
FROM logs-entityanalytics_entra_id*, metrics-system.uptime-*
// 2. Set Time Window (e.g., look back 24 hours to ensure we don't alert on transient blips)
| WHERE @timestamp > NOW() - 24 hour
// 3. Normalize the Asset Name
//    If the event is from Entra, use 'azure_ad.displayName'.
//    If the event is from Fleet, use 'host.name'.
//    Convert to lowercase to ensure 'Desktop-ABC' matches 'desktop-abc'.
| EVAL asset_name = CASE(
    ISNOTNULL(azure_ad.displayName), TO_LOWER(azure_ad.displayName),
    ISNOTNULL(host.name), TO_LOWER(host.name)
   )
// 4. Filter out any logs that didn't have a name
| WHERE ISNOTNULL(asset_name)
// 5. Pivot / Aggregate: Count how many times we saw this device in Entra vs Fleet
| STATS
    entra_inventory_count = COUNT_IF(ISNOTNULL(azure_ad.displayName)),
    fleet_heartbeat_count = COUNT_IF(ISNOTNULL(host.name))
  BY asset_name
// 6. The Gap Analysis Logic
//    Show me devices that exist in Entra Inventory (> 0)
//    BUT have sent ZERO heartbeats to Fleet (== 0)
| WHERE entra_inventory_count > 0 AND fleet_heartbeat_count == 0
| SORT asset_name ASC
| LIMIT 100
