// 1. Source both the Entra Device Inventory and Fleet Agent Heartbeats
FROM logs-entityanalytics_entra_id*, metrics-system.uptime-*
// 2. Set Time Window (e.g., look back 24 hours to ensure we don't alert on transient blips)
| WHERE @timestamp > NOW() - 24 hour
// 3. Normalize the Asset Name
//    If the event is from Entra, use 'azure_ad.displayName'.
//    If the event is from Fleet, use 'host.name'.
//    Convert to lowercase to ensure 'Desktop-ABC' matches 'desktop-abc'.
| EVAL asset_name = CASE(
    ISNOTNULL(azure_ad.displayName), TO_LOWER(azure_ad.displayName),
    ISNOTNULL(host.name), TO_LOWER(host.name)
   )
// 4. Filter out any logs that didn't have a name
| WHERE ISNOTNULL(asset_name)
// 5. Pivot / Aggregate: Count how many times we saw this device in Entra vs Fleet
| STATS
    entra_inventory_count = COUNT_IF(ISNOTNULL(azure_ad.displayName)),
    fleet_heartbeat_count = COUNT_IF(ISNOTNULL(host.name))
  BY asset_name
// 6. The Gap Analysis Logic
//    Show me devices that exist in Entra Inventory (> 0)
//    BUT have sent ZERO heartbeats to Fleet (== 0)
| WHERE entra_inventory_count > 0 AND fleet_heartbeat_count == 0
| SORT asset_name ASC
| LIMIT 100



Shadow IT / Missing Agent Report:

Device Name: {{context.item.asset_name}}
Source: Microsoft Entra ID Entity Analytics
Issue: Device is listed in Entra ID inventory but has sent NO heartbeat to Elastic Fleet in the last 24 hours.

Troubleshooting:
1. Check if the device is turned on.
2. Verify Elastic Agent service is running.
3. Run Intune remediation script if applicable.

3. Rule Configuration Steps

    Rule Type: Select Elasticsearch query.

    Query Language: Select ES|QL.

    Query: Paste the code block above.

    Action Frequency: Run this Daily (e.g., "Every 1 day").

        Reason: Inventory data doesn't change by the minute. Running this hourly might be noisy if a device reboots.

    Alert Grouping: "Create an alert for each row".

        This ensures you get a specific alert for "DESKTOP-LETW452G" rather than a generic "Devices Missing" alert.

4. Alert Message (Mustache Template)

When configuring the email or Slack notification, use these variables:

    Subject: Gap Detected: Device '{{context.item.asset_name}}' is missing Elastic Agent

    Body:
